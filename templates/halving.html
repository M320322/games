{% extends "base.html" %}

{% block title %}Halving Game - Games Collection{% endblock %}

{% block content %}
<div class="game-page">
    <h1>Halving Game</h1>
    
    <div class="game-setup" id="gameSetup">
        <h2>Game Setup</h2>
        <form id="newGameForm">
            <div class="form-group">
                <label for="startingNumber">Starting Number:</label>
                <input type="number" id="startingNumber" name="starting_number" value="15" min="1" max="100">
            </div>
            
            <div class="form-group">
                <label for="player1Type">Player 1:</label>
                <select id="player1Type" name="player1_type">
                    <option value="human">Human</option>
                    <option value="random">Random AI</option>
                    <option value="minimax">Minimax AI</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="player2Type">Player 2:</label>
                <select id="player2Type" name="player2_type">
                    <option value="random" selected>Random AI</option>
                    <option value="human">Human</option>
                    <option value="minimax">Minimax AI</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">Start Game</button>
        </form>
    </div>

    <div class="game-area" id="gameArea" style="display: none;">
        <div class="game-state">
            <h2>Current Number: <span id="currentNumber"></span></h2>
            <p id="currentPlayer"></p>
            <p id="gameStatus"></p>
        </div>
        
        <div class="game-actions" id="gameActions">
            <h3>Choose your action:</h3>
            <div class="action-buttons">
                <button class="btn btn-action" onclick="makeMove('subtract')">Subtract 1</button>
                <button class="btn btn-action" onclick="makeMove('halve')">Divide by 2</button>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="resetGame()">New Game</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSessionId = null;

document.getElementById('newGameForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/api/halving/new', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.session_id) {
            currentSessionId = data.session_id;
            updateGameDisplay(data.game_state);
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
        }
    } catch (error) {
        console.error('Error starting game:', error);
    }
});

async function makeMove(action) {
    if (!currentSessionId) return;
    
    const formData = new FormData();
    formData.append('action', action);
    
    try {
        const response = await fetch(`/api/game/${currentSessionId}/move`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateGameDisplay(data.game_state);
        } else if (data.error) {
            alert(data.error);
        }
    } catch (error) {
        console.error('Error making move:', error);
    }
}

function updateGameDisplay(gameState) {
    document.getElementById('currentNumber').textContent = gameState.number;
    
    if (gameState.is_game_over) {
        document.getElementById('currentPlayer').textContent = '';
        const displayWinner = gameState.winner === 1 ? 1 : 2;
        document.getElementById('gameStatus').textContent = `Game Over! Player ${displayWinner} wins!`;
        document.getElementById('gameActions').style.display = 'none';
    } else {
        const displayPlayer = gameState.current_player === 1 ? 1 : 2;
        document.getElementById('currentPlayer').textContent = `Player ${displayPlayer}'s turn`;
        document.getElementById('gameStatus').textContent = '';
        
        // Show/hide action buttons based on valid actions
        const subtractBtn = document.querySelector('[onclick="makeMove(\'subtract\')"]');
        const halveBtn = document.querySelector('[onclick="makeMove(\'halve\')"]');
        
        subtractBtn.style.display = gameState.valid_actions.includes('subtract') ? 'inline-block' : 'none';
        halveBtn.style.display = gameState.valid_actions.includes('halve') ? 'inline-block' : 'none';
        
        // Hide actions if it's AI turn
        const player1Type = document.getElementById('player1Type').value;
        const player2Type = document.getElementById('player2Type').value;
        const currentPlayerType = gameState.current_player === 1 ? player1Type : player2Type;
        
        if (currentPlayerType !== 'human') {
            document.getElementById('gameActions').style.display = 'none';
            setTimeout(() => checkGameState(), 1000); // Check for AI moves
        } else {
            document.getElementById('gameActions').style.display = 'block';
        }
    }
}

async function checkGameState() {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/api/game/${currentSessionId}/state`);
        const gameState = await response.json();
        updateGameDisplay(gameState);
    } catch (error) {
        console.error('Error checking game state:', error);
    }
}

function resetGame() {
    currentSessionId = null;
    document.getElementById('gameSetup').style.display = 'block';
    document.getElementById('gameArea').style.display = 'none';
}
</script>
{% endblock %}
