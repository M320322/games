{% extends "base.html" %}

{% block title %}Tic-Tac-Toe - Games Collection{% endblock %}

{% block content %}
<div class="game-page">
    <h1>Tic-Tac-Toe</h1>
    
    <div class="game-setup" id="gameSetup">
        <h2>Game Setup</h2>
        <form id="newGameForm">
            <div class="form-group">
                <label for="player1Type">Player 1 (X):</label>
                <select id="player1Type" name="player1_type">
                    <option value="human" selected>Human</option>
                    <option value="random">Random AI</option>
                    <option value="minimax">Minimax AI</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="player2Type">Player 2 (O):</label>
                <select id="player2Type" name="player2_type">
                    <option value="random" selected>Random AI</option>
                    <option value="human">Human</option>
                    <option value="minimax">Minimax AI</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">Start Game</button>
        </form>
    </div>

    <div class="game-area" id="gameArea" style="display: none;">
        <div class="game-state">
            <p id="currentPlayer"></p>
            <p id="gameStatus"></p>
        </div>
        
        <div class="tictactoe-board" id="board">
            <!-- Board will be generated by JavaScript -->
        </div>
        
        <button class="btn btn-secondary" onclick="resetGame()">New Game</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSessionId = null;
let currentBoard = null;

document.getElementById('newGameForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/api/tictactoe/new', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.session_id) {
            currentSessionId = data.session_id;
            updateGameDisplay(data.game_state);
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
        }
    } catch (error) {
        console.error('Error starting game:', error);
    }
});

async function makeMove(row, col) {
    if (!currentSessionId) return;
    
    const formData = new FormData();
    formData.append('action', `${row},${col}`);
    
    try {
        const response = await fetch(`/api/game/${currentSessionId}/move`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateGameDisplay(data.game_state);
        } else if (data.error) {
            alert(data.error);
        }
    } catch (error) {
        console.error('Error making move:', error);
    }
}

function updateGameDisplay(gameState) {
    currentBoard = gameState.board;
    
    // Update board display
    const board = document.getElementById('board');
    board.innerHTML = '';
    
    for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
            const cell = document.createElement('div');
            cell.className = 'board-cell';
            
            const cellValue = gameState.board[i][j];
            if (cellValue === 1) {
                cell.textContent = 'X';
                cell.classList.add('player-x');
            } else if (cellValue === -1) {
                cell.textContent = 'O';
                cell.classList.add('player-o');
            } else {
                cell.textContent = '';
                if (!gameState.is_game_over) {
                    cell.onclick = () => makeMove(i, j);
                    cell.classList.add('clickable');
                }
            }
            
            board.appendChild(cell);
        }
    }
    
    // Update game status
    if (gameState.is_game_over) {
        document.getElementById('currentPlayer').textContent = '';
        if (gameState.winner) {
            const symbol = gameState.winner === 1 ? 'X' : 'O';
            const displayPlayer = gameState.winner === 1 ? 1 : 2;
            document.getElementById('gameStatus').textContent = `Game Over! Player ${displayPlayer} (${symbol}) wins!`;
        } else {
            document.getElementById('gameStatus').textContent = 'Game Over! It\'s a draw!';
        }
    } else {
        const symbol = gameState.current_player === 1 ? 'X' : 'O';
        document.getElementById('currentPlayer').textContent = `Player ${gameState.current_player === 1 ? 1 : 2} (${symbol})'s turn`;
        document.getElementById('gameStatus').textContent = '';
        
        // Check if it's AI turn
        const player1Type = document.getElementById('player1Type').value;
        const player2Type = document.getElementById('player2Type').value;
        const currentPlayerType = gameState.current_player === 1 ? player1Type : player2Type;
        
        if (currentPlayerType !== 'human') {
            setTimeout(() => checkGameState(), 1000); // Check for AI moves
        }
    }
}

async function checkGameState() {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/api/game/${currentSessionId}/state`);
        const gameState = await response.json();
        updateGameDisplay(gameState);
    } catch (error) {
        console.error('Error checking game state:', error);
    }
}

function resetGame() {
    currentSessionId = null;
    currentBoard = null;
    document.getElementById('gameSetup').style.display = 'block';
    document.getElementById('gameArea').style.display = 'none';
}
</script>
{% endblock %}
