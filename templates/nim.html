{% extends "base.html" %}

{% block title %}Nim - Games Collection{% endblock %}

{% block content %}
<div class="game-page">
    <h1>Nim Game</h1>
    
    <div class="game-setup" id="gameSetup">
        <h2>Game Setup</h2>
        <form id="newGameForm">
            <div class="form-group">
                <label for="piles">Pile Configuration:</label>
                <input type="text" id="piles" name="piles" value="1,3,5,7" placeholder="e.g., 1,3,5,7">
                <small>Enter pile sizes separated by commas</small>
            </div>
            
            <div class="form-group">
                <label for="player1Type">Player 1:</label>
                <select id="player1Type" name="player1_type">
                    <option value="human" selected>Human</option>
                    <option value="random">Random AI</option>
                    <option value="minimax">Minimax AI</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="player2Type">Player 2:</label>
                <select id="player2Type" name="player2_type">
                    <option value="random" selected>Random AI</option>
                    <option value="human">Human</option>
                    <option value="minimax">Minimax AI</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">Start Game</button>
        </form>
    </div>

    <div class="game-area" id="gameArea" style="display: none;">
        <div class="game-state">
            <p id="currentPlayer"></p>
            <p id="gameStatus"></p>
            <p id="gameInfo"></p>
        </div>
        
        <div class="nim-board" id="board">
            <!-- Piles will be generated by JavaScript -->
        </div>
        
        <div class="nim-actions" id="actions" style="display: none;">
            <h3>Make Your Move</h3>
            <div class="move-controls">
                <label for="selectedPile">Select Pile:</label>
                <select id="selectedPile">
                    <!-- Options will be populated by JavaScript -->
                </select>
                
                <label for="objectsToRemove">Objects to Remove:</label>
                <input type="number" id="objectsToRemove" min="1" value="1">
                
                <button onclick="makeMove()" class="btn btn-primary">Make Move</button>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="resetGame()">New Game</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSessionId = null;
let currentGameState = null;

document.getElementById('newGameForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/api/nim/new', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.session_id) {
            currentSessionId = data.session_id;
            updateGameDisplay(data.game_state);
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
        }
    } catch (error) {
        console.error('Error starting game:', error);
    }
});

async function makeMove() {
    if (!currentSessionId) return;
    
    const pileIndex = parseInt(document.getElementById('selectedPile').value);
    const objectsToRemove = parseInt(document.getElementById('objectsToRemove').value);
    
    if (isNaN(pileIndex) || isNaN(objectsToRemove) || objectsToRemove < 1) {
        alert('Please select a valid pile and number of objects to remove');
        return;
    }
    
    const formData = new FormData();
    formData.append('action', `${pileIndex},${objectsToRemove}`);
    
    try {
        const response = await fetch(`/api/game/${currentSessionId}/move`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateGameDisplay(data.game_state);
        } else if (data.error) {
            alert(data.error);
        }
    } catch (error) {
        console.error('Error making move:', error);
    }
}

function updateGameDisplay(gameState) {
    currentGameState = gameState;
    
    // Update board display
    const board = document.getElementById('board');
    board.innerHTML = '';
    
    gameState.piles.forEach((pileSize, index) => {
        const pileDiv = document.createElement('div');
        pileDiv.className = 'nim-pile';
        
        const pileLabel = document.createElement('div');
        pileLabel.className = 'pile-label';
        pileLabel.textContent = `Pile ${index + 1} (${pileSize})`;
        pileDiv.appendChild(pileLabel);
        
        const objectsDiv = document.createElement('div');
        objectsDiv.className = 'pile-objects';
        
        for (let i = 0; i < pileSize; i++) {
            const obj = document.createElement('div');
            obj.className = 'nim-object';
            obj.textContent = '●';
            objectsDiv.appendChild(obj);
        }
        
        pileDiv.appendChild(objectsDiv);
        board.appendChild(pileDiv);
    });
    
    // Update move controls
    const selectedPile = document.getElementById('selectedPile');
    selectedPile.innerHTML = '';
    
    gameState.piles.forEach((pileSize, index) => {
        if (pileSize > 0) {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Pile ${index + 1} (${pileSize} objects)`;
            selectedPile.appendChild(option);
        }
    });
    
    // Update object removal range
    updateObjectsToRemoveRange();
    
    // Update game status
    if (gameState.is_game_over) {
        document.getElementById('currentPlayer').textContent = '';
        document.getElementById('actions').style.display = 'none';
        
        if (gameState.winner) {
            const displayPlayer = gameState.winner === 1 ? 1 : 2;
            document.getElementById('gameStatus').textContent = `Game Over! Player ${displayPlayer} wins!`;
        } else {
            document.getElementById('gameStatus').textContent = 'Game Over! It\'s a draw!';
        }
        document.getElementById('gameInfo').textContent = '';
    } else {
        const displayPlayer = gameState.current_player === 1 ? 1 : 2;
        document.getElementById('currentPlayer').textContent = `Player ${displayPlayer}'s turn`;
        document.getElementById('gameStatus').textContent = '';
        
        // Show game info
        let infoText = `Total objects: ${gameState.total_objects}`;
        if (gameState.nim_sum !== undefined) {
            infoText += ` | Nim-sum: ${gameState.nim_sum}`;
        }
        document.getElementById('gameInfo').textContent = infoText;
        
        // Check if it's human player's turn
        const player1Type = document.getElementById('player1Type').value;
        const player2Type = document.getElementById('player2Type').value;
        const currentPlayerType = gameState.current_player === 1 ? player1Type : player2Type;
        
        if (currentPlayerType === 'human') {
            document.getElementById('actions').style.display = 'block';
        } else {
            document.getElementById('actions').style.display = 'none';
            setTimeout(() => checkGameState(), 1000); // Check for AI moves
        }
    }
}

function updateObjectsToRemoveRange() {
    const selectedPileIndex = parseInt(document.getElementById('selectedPile').value);
    const objectsInput = document.getElementById('objectsToRemove');
    
    if (!isNaN(selectedPileIndex) && currentGameState) {
        const maxObjects = currentGameState.piles[selectedPileIndex];
        objectsInput.max = maxObjects;
        objectsInput.value = Math.min(parseInt(objectsInput.value) || 1, maxObjects);
    }
}

// Update range when pile selection changes
document.getElementById('selectedPile').addEventListener('change', updateObjectsToRemoveRange);

async function checkGameState() {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/api/game/${currentSessionId}/state`);
        const gameState = await response.json();
        updateGameDisplay(gameState);
    } catch (error) {
        console.error('Error checking game state:', error);
    }
}

function resetGame() {
    currentSessionId = null;
    currentGameState = null;
    document.getElementById('gameSetup').style.display = 'block';
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('actions').style.display = 'none';
}
</script>
{% endblock %}
